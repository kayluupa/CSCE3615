<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Apartments</title>
    <link rel="stylesheet" href="navbar/navbar.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="navbar-container"></div>
    <div class="search-container">
        <div class="search-header">
            <input type="text" id="searchBar" class="search-input" placeholder="Enter Zip Code">
            <button id="filterBtn" class="filter-btn">
                <img src="images/filterResults.svg" alt="Filter Icon" />
            </button>
        </div>

        <div id="filterOptions" class="filter-options" style="display: none;">
            <div class="filter-option">
                <label for="price">Price:</label>
                <select id="price" onchange="filterResults()">
                    <option value="">Any</option>
                    <option value="1000">Under $1000</option>
                    <option value="2000">$1000 - $2000</option>
                    <option value="3000">$2000 - $3000</option>
                    <option value="4000">$3000+</option>
                </select>
            </div>
            <div class="filter-option">
                <label for="bedrooms">Bedrooms:</label>
                <select id="bedrooms" onchange="filterResults()">
                    <option value="">Any</option>
                    <option value="1">1 Bedroom</option>
                    <option value="2">2 Bedrooms</option>
                    <option value="3">3 Bedrooms</option>
                    <option value="4">4+ Bedrooms</option>
                </select>
            </div>
            <div class="filter-option">
                <label for="bathrooms">Bathrooms:</label>
                <select id="bathrooms" onchange="filterResults()">
                    <option value="">Any</option>
                    <option value="1">1 Bathroom</option>
                    <option value="2">2 Bathrooms</option>
                    <option value="3">3 Bathrooms</option>
                    <option value="4">4+ Bathrooms</option>
                </select>
            </div>
            <div class="filter-option" id="amenity-options">
                <label>Amenities:</label>
                <div class="checkbox-group">
                    <input type="checkbox" id="highSpeedInternet" name="amenities" value="High-speed Internet">
                    <label for="highSpeedInternet">High-speed Internet</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="clubhouse" name="amenities" value="Clubhouse">
                    <label for="clubhouse">Clubhouse</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="pool" name="amenities" value="Pool">
                    <label for="pool">Pool</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="parkingGarage" name="amenities" value="Parking Garage">
                    <label for="parkingGarage">Parking Garage</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="newAppliances" name="amenities" value="New Appliances">
                    <label for="newAppliances">New Appliances</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="gym" name="amenities" value="Gym">
                    <label for="gym">Gym</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="petAmenities" name="amenities" value="Pet Amenities">
                    <label for="petAmenities">Pet Amenities</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="inUnitLaundry" name="amenities" value="In-Unit Laundry">
                    <label for="inUnitLaundry">In-Unit Laundry</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="washerDryerHookups" name="amenities" value="Washer/Dryer Hookups">
                    <label for="washerDryerHookups">Washer/Dryer Hookups</label>
                </div>
            </div>            
        </div>
        <ul id="apartmentList">
        </ul>
        <p id="noResultsMessage" style="display:none;">No results found</p>
    </div>

    <script type="module">
        import { fetchApartmentData } from './database.js';
        import './filter.js'; 
        import { toggleHeart } from './hearticon.js';

        window.toggleHeart = toggleHeart;

        async function displayApartments() {
            const apartmentList = document.getElementById('apartmentList');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const apartments = await fetchApartmentData();

            console.log('Fetched Apartments:', apartments); // Debugging statement

            apartmentList.innerHTML = ''; // Clear existing content

            if (apartments) {
                const urlParams = new URLSearchParams(window.location.search);
                const zipcode = urlParams.get('zipcode');

                let filteredApartments = Object.keys(apartments).map(key => ({ id: key, ...apartments[key] }));

                if (zipcode) {

                    filteredApartments = filteredApartments.filter(apartment => apartment.ZipCode === zipcode.trim());

                }

                if (filteredApartments.length > 0) {
                    filteredApartments.forEach(apartment => {
                        console.log('Apartment ID:', apartment.id); // Debugging statement
                        const listItem = document.createElement('li');
                        listItem.setAttribute('data-zipcode', apartment.ZipCode);
                        listItem.setAttribute('data-price', apartment.Price);
                        listItem.setAttribute('data-bedrooms', apartment.Bedroom);
                        listItem.setAttribute('data-bathrooms', apartment.Bathroom);
                        listItem.setAttribute('data-amenities', apartment.Amenities);

                        listItem.innerHTML = `
                            <div class="listing" data-id="${apartment.id}" onclick="viewApartmentDetails('${apartment.id}')">
                                <div class="heart-icon" onclick="event.stopPropagation(); toggleHeart(this);">
                                    <img src="images/heart-icon.svg" alt="Heart Icon">
                                </div>
                                <h3>${apartment.id}</h3>
                                <p>Price: $${apartment.Price}</p>
                                <p>Bedrooms: ${apartment.Bedroom}</p>
                                <p>Bathrooms: ${apartment.Bathroom}</p>
                                <p>Zip: ${apartment.ZipCode}</p>
                                <p>Amenities: ${apartment.Amenities}</p>
                            </div>
                        `;
                        apartmentList.appendChild(listItem);
                    });
                    noResultsMessage.style.display = 'none';
                } else {
                    noResultsMessage.style.display = 'block';
                }
            } else {
                noResultsMessage.style.display = 'block';
            }
        }

        window.onload = async function() {
            await displayApartments();
            filterResults(); // Ensure filtering is applied after loading apartments
        };

        window.viewApartmentDetails = function(apartmentId) {
            window.location.href = `apartment-details.html?id=${apartmentId}`;
        }

        document.getElementById('searchBar').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                filterResults();
            }
        });

        function filterResults() {
            const searchBar = document.getElementById('searchBar').value.trim();
            const priceFilter = document.getElementById('price').value;
            const bedroomsFilter = document.getElementById('bedrooms').value;
            const bathroomsFilter = document.getElementById('bathrooms').value;
            const amenitiesFilter = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(el => el.value);

            console.log('Filter criteria:');
            console.log('Zipcode:', searchBar);
            console.log('Price:', priceFilter);
            console.log('Bedrooms:', bedroomsFilter);
            console.log('Bathrooms:', bathroomsFilter);
            console.log('Selected Amenities:', amenitiesFilter);

            const apartments = Array.from(document.querySelectorAll('#apartmentList li'));

            apartments.forEach(apartment => {
                const matchesZipcode = searchBar === "" || apartment.getAttribute('data-zipcode').trim() === searchBar;
                const matchesPrice = priceFilter === "" || parseInt(apartment.getAttribute('data-price'), 10) <= parseInt(priceFilter, 10);
                const matchesBedrooms = bedroomsFilter === "" || apartment.getAttribute('data-bedrooms') === bedroomsFilter;
                const matchesBathrooms = bathroomsFilter === "" || apartment.getAttribute('data-bathrooms') === bathroomsFilter;
                const matchesAmenities = amenitiesFilter.length === 0 || amenitiesFilter.every(amenity => apartment.getAttribute('data-amenities').includes(amenity));

                if (matchesZipcode && matchesPrice && matchesBedrooms && matchesBathrooms && matchesAmenities) {
                    apartment.style.display = 'block';
                } else {
                    apartment.style.display = 'none';
                }
            });

            const visibleApartments = apartments.filter(apartment => apartment.style.display === 'block');
            const noResultsMessage = document.getElementById('noResultsMessage');
            noResultsMessage.style.display = visibleApartments.length === 0 ? 'block' : 'none';
        }
    </script>
    <script type="module" src="navbar/navbar.js"></script>
</body>
</html>
